---
layout: post
title: 哈希函数中的生日攻击
---


<!-- more -->

在密码学中，针对哈希函数有一类攻击方式称为生日攻击，在讨论生日攻击之前我们先思考下面一个符合直觉的生日问题：

> 假设一个房间里面有 N 个人，当 N 多大时，有超过 $\frac{1}{2}$ 的概率能找到生日与你相同的人。（假设生日出现的概率相同）

<!-- # 生日攻击
1. 生日问题中的概率计算方法
2. 生日悖论
3. 一般形式的公式
4. 生日攻击中的应用 -->

## 符合直觉的生日问题
在密码学中，针对哈希函数有一类攻击方式称为生日攻击，在讨论生日攻击之前我们先思考下面一个符合直觉的生日问题：

> 假设一个房间里面有 N 个人，当 N 多大时，有超过 \\(\frac{1}{2}\\) 的概率能找到生日与你相同的人。（假设生日出现的概率相同）

换言之，我们需要找到一个 N 的值，使得事件 “找到至少一个和你生日相同的人” 发生的概率大于 \\(\frac{1} {2}\\), 计算这个事件发生的概率，求它的补集更加容易：“ N 个人中没有人的生日与你的生日相同”，你的生日是365天中的一天，任意一个人和你生日不相同的概率是 \\( \frac{364}{365} \\), N个人都和你生日不同的概率则是 

$$ \begin{matrix} 
P(\overline{n}) = 
\underbrace{
    \frac{364}{365} \times \frac{364}{365} \times \cdots \times \frac{364}{365}
    } 
    \\ N 
\end{matrix}  = ( \frac{364}{365} ) ^ N
$$

至少一个人与你生日相同的概率则是

$$ P(n) =  1 - ( \frac{364}{365} ) ^ N $$

令上式等于 \\( \frac{1}{2} \\)，解得 \\( N \approx 253 \\).
这个答案还是挺符合我们的直觉的，当你想要找一个和你生日相同的人的时候，在253个人中，你有大于 \\( \frac{1}{2} \\) 的概率能找到一个这样的人。

## 生日悖论
下面再看一个计算方法类似，但是结果会让人感到迷惑的一个生日问题，因为它的反直觉，这个问题也被称作“生日悖论”：
> 假设一个房间里面有 N 个人，当 N 为多大时，有超过\\(\frac{1} {2}\\)的可能出现生日相同的人？

同样的，想要计算事件 “房间内至少存在两个人生日相同” 发生的概率，计算这个事件的补集发生的概率更为容易： “房间内任意两个人的生日都不同”。
对房间内的 N 个人编号从 1 到 N，要使房间内每个人的生日都不同，第一个人的生日可以随意选取，有365种选择，第二个人的生日不能与第一个人相同，有364种选择，第三个人不能与前两个人相同，有363种选择，以此类推，第 N 个人有 365 - （N - 1）种选择。则事件 “房间内任意两个人的生日都不同” 的概率是

$$ P(\overline{A}) = \frac{365} {365} \times \frac {364} {365} \times \frac{363} {365} \times \cdots \times \frac{365 - N + 1} {365} $$

事件“房间内至少存在两个人生日相同”的概率是

$$ P(A) = 1-P(\overline{A}) = 1 - \frac{365} {365} \times \frac {364} {365} \times \frac{363} {365} \times \cdots \times \frac{365 - N + 1} {365}$$

令上式大于等于 \\(\frac{1}{2}\\)，解得 \\( N \approx 23 \\).
是不是有些违反直觉，当房间内存在23个人的时候，就有超过 \\(\frac{1}{2}\\)的概率有两个人的生日相同。但实际上稍加思索就可以想通:
当房间内存在N个人的时候，想要找出生日相同的两个人，我们需要两两比较，第一个人和 其余 N-1 人比较 N-1 次，第二个人和其余 N-2 人比较 N-2 次， \\( \ldots \\)， 第 N-1 个人和第N个人比较 1 次，总共的比较次数是：

$$ 1 + 2 + 3 + \cdots N-1 = \frac{N (N - 1)}{2}  $$

N = 23 时，比较次数是253次，与上面符合直觉的答案一致。


## 一般形式的解
从上面的 “生日悖论”，我们得到 “至少两个人生日相同的概率”为

$$
    P(A) =  1 - \frac{365} {365} \times \frac {364} {365} \times \frac{363} {365} \times \cdots \times \frac{365 - N + 1} {365}
     = 1 - 1 \times (1-\frac{1} {365}) \times (1-\frac{2} {365})  \times (1-\frac{3} {365} \cdots)  \times (1-\frac{n-1} {365})
$$

根据泰勒公式，指数函数 \\(e^x\\) 可以用多项式展开

$$e^x = \sum_{k=0}^{\infty} \frac{x^k}{k!} = 1 + x + \frac{x^2}{2}+ \frac{x^3}{6} + \frac{x^4}{24} + \cdots$$

当 \\( x \\) 非常小的时候

$$e^x \approx 1+x$$

把 \\(- \frac{1}{365} \\) 带入 \\( x \\) 得到 

$$e^ {-\frac{1}{365}} \approx 1-\frac{1}{365} $$

于是有

$$P(A) =1 - e^{-\frac{1}{365}} \cdot e^{-\frac{2}{365}} \cdot e^{-\frac{3}{365}} \ldots \cdot e^{-\frac{n-1}{365}}  \\ =
1-e^{-\frac{n(n-1)/2}{365}}$$

将上述生日问题抽象成更一般的形式：从 H 个数中，随机均匀的选择 n 个数， P(n;H)为事件“至少一个值被选择多于一次”的概率,我们可以得到

$$P(n;H) = 1 - e ^{-\frac{n(n-1)}{2H}}$$  

把事件 “至少一个值被选择多于一次”为碰撞，
从上面的讨论我们可以知道，碰撞发生的概率和两个因素有关，
1. 所有可能的取值的个数H。我们称为取值空间的大小
2. 选择的数的个数n，
## 生日攻击
假设一个哈希函数产生 d 位二进制长度的输出，则有 \\(H = 2^d \\) 种可能的取值。对于一个好的哈希函数，我们希望所有输出概率上是相等的。根据上面的生日问题，我们知道对 \\(n\\) 个不同的输入执行哈希运算，就会有 \\(P(n;H) \\) 的概率产生碰撞，当这个概率达到\\(\frac{1}{2}\\),我们就认为碰撞是会发生的也就是说这个哈希函数是不安全的。在\\(n,H\\)中，当哈希函数确定的时候\\(H\\)就已经确定，令 \\(P(n;H)=\frac{1}{2}\\)，可以得到

$$n \approx \sqrt{1.774H} \approx \sqrt {\frac{\pi}{2} H}$$

也就是说对这个哈希函数，选择 \\(\sqrt {\frac{\pi}{2} H}\\) 个不同的输入进行哈希，就会产生一次碰撞。

## 参考

[wiki](https://zh.wikipedia.org/wiki/%E7%94%9F%E6%97%A5%E6%94%BB%E5%87%BB) <br>
[阮一峰的网络日志](https://ruanyifeng.com/blog/2018/09/hash-collision-and-birthday-attack.html)<br>
[博客园文章](https://www.cnblogs.com/backnullptr/p/12132476.html) <br>